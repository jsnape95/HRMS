@model HRMS.Models.ApplicationUser

@{
    ViewBag.Title = "My Holidays";
}

<div class="row">
    @if (Model.Employee == null)
    {
        <div class="col-md-12">
            <p class="error">You are not currently logged as an employee on this system, please refer to HR.</p>
        </div>
    }
    else
    {

        <div class="col-md-3">
            <div class="box box-primary box-solid">
                <div class="box-header">
                    <h3 class="box-title">Enitlement Summary</h3>
                </div>
                <div class="box-body">
                    <div class="row">
                        <div class="col-md-12">
                            <h4>Entitlement Amount:  
                                <span class="pull-right">
                                    <span class="label label-primary pull-right">@Model.Employee.HolidayEntitlement</span>
                                </span>
                            </h4>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12">
                            <h4>
                                Current Remaining:
                                <span class="pull-right">
                                    <span class="label label-success pull-right">@ViewBag.CurrentRemaining</span>
                                </span>
                            </h4>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12">
                            <h4>
                                Provisional Remaining:
                                <span class="pull-right">
                                    <span class="label label-warning pull-right">@ViewBag.ProvisionalRemaining</span>
                                </span>
                            </h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-9">
            <div class="box box-primary">
                <div class="box-body">
                    <div id="holiday-calendar"></div>
                </div>
            </div>
        </div>

    }
</div>

@section scripts {
  
    <script>
        $(document).ready(function () {

            var provisionalDays = @ViewBag.ProvisionalRemaining ;

            $('#holiday-calendar').fullCalendar({
                weekends: false,
                selectable: true,
                showNonCurrentDates: false,
                select: function (start, end) {

                    startDate = formatDate(start);
                    endDate = formatDate(end);

                    $.ajax({
                        type: "GET",
                        url: "/Holiday/RequestHoliday",
                        data: {
                            start: startDate,
                            end: endDate,
                            provisionalDays: provisionalDays
                        },
                        success: function (data) {
                            if (data.status == 0) {
                                bootbox.alert("You can not make another holiday request as you currently do not have any provisional days remaining.");
                            }
                            else if (data.status == 1) {
                                bootbox.alert("The number of days that have been requested are above your provisonal amount remaining. Please try again.");
                            }
                            else if (data.status == 2) {
                                bootbox.alert("You have already made a holiday request for the chosen date(s). Please try again.");
                            }
                            else {
                                bootbox.dialog({
                                    title: "Holiday Request",
                                    message: data,
                                    className: "modalMedium"
                                });
                            }
                        }
                    });
                },
                header: {
                    left: '',
                    center: 'title',
                    right: 'today prev,next'
                },
                events: {
                    url: '@Url.Action("GetUsersHolidays", "Holiday")',
                    type: 'GET',
                    data: {
                    },
                    error: function () {
                        alert('there was an error while fetching events!');
                    }
                },
                eventClick: function(calEvent, jsEvent, view) {

                    $.ajax({
                        type: "GET",
                        url: "/Holiday/HolidayInformation",
                        data: {
                            linkId: calEvent.id
                        },
                        success: function (data) {
                            
                            bootbox.dialog({
                                title: "Holiday Information",
                                message: data,
                                className: "modalMedium"
                            });
                        }
                    });
                    
                    //alert('Coordinates: ' + jsEvent.pageX + ',' + jsEvent.pageY);
                    //alert('View: ' + view.name);

                    // change the border color just for fun
                    //$(this).css('border-color', 'red');

                }
            });

            function formatDate(date) {

                var dateObj = new Date(date);
                var momentObj = moment(dateObj);
                var momentString = momentObj.format('YYYY-MM-DD');
                return momentString;
            }


        });
    </script>  

}
