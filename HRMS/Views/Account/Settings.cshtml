@model List<HRMS.Models.ApplicationUser>
@{
    ViewBag.Title = "Admin Settings";
}

@section Breadcrumbs{
    <ol class="breadcrumb">
        <li><i class="fa fa-cog"></i> Settings</li>
        <li class="active">@ViewBag.Title</li>
    </ol>
}

<div clss="row">
    <div class="col-md-12">
        <div class="nav-tabs-custom">
            <ul class="nav nav-tabs">
                <li class="active"><a href="#users" data-toggle="tab">Users</a></li>
            </ul>
            <div class="tab-content">
                <div class="active tab-pane" id="users">
                    <table class="table table-hover table-condensed table-responsive">
                        <thead>
                            <tr>
                                <th>First Name</th>
                                <th>Last Name</th>
                                <th>Email Address</th>
                                <th>Role</th>
                                <th>Employee ID</th>
                                <th>More Options</th>
                            </tr>
                        </thead>    
                        <tbody>
                            @foreach (var user in Model)
                            {
                                <tr data-id="@user.Id" data-name="@user.Firstname @user.Lastname">
                                    <td>@user.Firstname</td>
                                    <td>@user.Lastname</td>
                                    <td>@user.Email</td>
                                    <td>@((user.Roles.FirstOrDefault().RoleId.ToString() == "1") ? "Admin" : "Standard")</td>
                                    <td>@(user.EmployeeId.ToString() ?? "Null")</td>
                                    <td>
                                        <ul class="nav navbar-nav">
                                            <li class="dropdown tasks-menu">
                                                <a href="#" class="dropdown-toggle a-normal-text" data-toggle="dropdown">
                                                    More Options <i class="caret"></i>
                                                </a>
                                                <ul class="dropdown-menu">
                                                    <li>
                                                        <!-- inner menu: contains the actual data -->
                                                        <ul class="menu">
                                                            @{
                                                                var x = (user.Roles.FirstOrDefault().RoleId.ToString() == "1");
                                                            }

                                                            @if (x)
                                                            {
                                                                <li class="standard"><a href="#">Demote to Standard</a></li>
                                                            }
                                                            else
                                                            {
                                                                <li class="admin"><a href="#">Promote to Admin</a></li>
                                                            }

                                                            @if (String.IsNullOrEmpty(user.EmployeeId.ToString()))
                                                            {
                                                                <li class="employee"><a href="#">Assign Employee</a></li>
                                                            }
                                                        </ul>
                                                    </li>
                                                </ul>
                                            </li>
                                        </ul>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts{
    <script>
        $(document).ready(function () {

            $('.employee').on('click', function () {

                var userId = $(this).closest('tr').data('id');

                $.ajax({
                    type: "GET",
                    data: {
                        id: userId
                    },
                    url: "/Account/AssociateEmployee",
                    beforeSend: function () {

                    },
                    success: function (data) {
                        bootbox.dialog({
                            title: "Are you sure you wish to accept " + name + "? If so please complete the information below.",
                            message: data,
                            className: "modalMedium"
                        });
                    }
                });
            });

            $('.standard').on('click', function () {
                var userId = $(this).closest('tr').data('id');
                var name = $(this).closest('tr').data('name');

                bootbox.confirm({
                    message: "Are you sure you wish to demote " + name + " to a standard user?",
                    buttons: {
                        confirm: {
                            label: 'Yes',
                            className: 'btn-success'
                        },
                        cancel: {
                            label: 'No',
                            className: 'btn-danger'
                        }
                    },
                    callback: function (result) {
                        if (result) {
                            $.ajax({
                                type: "POST",
                                data: {
                                    id: userId,
                                    promote: false
                                },
                                url: "/Account/ChangeUserRole",
                                success: function (data) {
                                    location.reload();
                                }
                            });
                        }
                    }
                });
            });

            $('.admin').on('click', function () {
                var userId = $(this).closest('tr').data('id');
                var name = $(this).closest('tr').data('name');

                bootbox.confirm({
                    message: "Are you sure you wish to promote " + name + " to an admin user?",
                    buttons: {
                        confirm: {
                            label: 'Yes',
                            className: 'btn-success'
                        },
                        cancel: {
                            label: 'No',
                            className: 'btn-danger'
                        }
                    },
                    callback: function (result) {
                        if (result) {
                            $.ajax({
                                type: "POST",
                                data: {
                                    id: userId,
                                    promote: true
                                },
                                url: "/Account/ChangeUserRole",
                                success: function (data) {
                                    location.reload();
                                }
                            });
                        }
                    }
                });
            });
        });
    </script>    
}